<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>alepaul vault</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@900&display=swap');
    body { margin:0; background:#0a0a0f; color:#e0e0ff; font-family:system-ui; overflow-x:hidden; }
    .logo { font-family:'Orbitron'; font-size:140px; text-align:center; margin:30px 0; background:linear-gradient(45deg,#8b5cf6,#ff6b6b); -webkit-background-clip:text; -webkit-text-fill-color:transparent; animation:pulse 4s infinite; text-shadow:0 0 50px #8b5cf6, 0 0 100px #8b5cf6; }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.08)} }
    h1 { text-align:center; font-size:42px; margin:10px; color:#8b5cf6; letter-spacing:2px; }
    .container { max-width:500px; margin:40px auto; padding:20px; background:#111118; border-radius:20px; box-shadow:0 0 40px rgba(139,92,246,0.3); }
    input, button, select { padding:14px; margin:12px 0; width:100%; border-radius:12px; border:none; font-size:16px; box-sizing:border-box; }
    button { background:#8b5cf6; color:white; cursor:pointer; font-weight:bold; transition:0.3s; }
    button:hover { background:#a78bfa; }
    .hidden { display:none; }
    .vault-container { max-width:1100px; }
    .chat { background:#111118; border-radius:16px; padding:15px; height:400px; overflow-y:auto; margin:20px 0; border:1px solid #333; }
    .msg { margin:10px 0; padding:12px; border-radius:12px; background:#1f1f2f; max-width:80%; word-wrap:break-word; }
    .msg.self { background:#8b5cf6; margin-left:auto; }
    .file-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:20px; }
    .file-item { background:#111118; padding:15px; border-radius:16px; text-align:center; position:relative; border:1px solid #333; }
    .delete-btn { position:absolute; top:8px; right:8px; background:#ff3333; padding:6px 12px; border-radius:8px; font-size:12px; cursor:pointer; }
    .user-item { background:#111118; padding:15px; border-radius:12px; margin:10px 0; display:flex; justify-content:space-between; align-items:center; }
    .msg-error { color:#ff6b6b; text-align:center; }
  </style>
</head>
<body>

  <!-- Auth -->
  <div id="auth" class="container">
    <div class="logo">A</div>
    <h1>alepaul vault</h1>
    
    <div id="loginForm">
      <input type="email" id="loginEmail" placeholder="Email" required />
      <input type="password" id="loginPass" placeholder="Password" required />
      <button onclick="login()">Login</button>
      <button onclick="showSignup()">Create Account</button>
      <p id="authMsg" class="msg-error"></p>
    </div>

    <div id="signupForm" class="hidden">
      <input type="text" id="displayName" placeholder="Display Name" required />
      <input type="email" id="newEmail" placeholder="Email" required />
      <input type="password" id="newPass" placeholder="Password (min 6 chars)" required />
      <button onclick="signup()">Create Account</button>
      <button onclick="showLogin()">Back to Login</button>
      <p id="signupMsg" class="msg-error"></p>
    </div>
  </div>

  <!-- Vault -->
  <div id="vault" class="container vault-container hidden">
    <div class="logo">A</div>
    <h1>alepaul <span id="welcome"></span></h1>
    <button onclick="logout()">Logout</button>
    <hr>

    <h2>Upload Files</h2>
    <input type="text" id="folderName" placeholder="Folder (optional)" />
    <input type="file" id="fileInput" multiple />
    <button onclick="uploadFiles()">Upload</button>
    <progress id="uploadProgress" value="0" max="100" style="width:100%;display:none;"></progress>

    <h2>Files & Folders</h2>
    <div id="files" class="file-grid"></div>

    <h2>Chat</h2>
    <div id="chat" class="chat"></div>
    <div style="display:flex;gap:10px;">
      <input type="text" id="chatInput" placeholder="Type message..." onkeypress="if(event.key==='Enter') sendMsg()" style="flex:1;" />
      <button onclick="sendMsg()">Send</button>
    </div>

    <!-- Admin Panel (only visible to admins) -->
    <div id="adminPanel" class="hidden">
      <h2 style="color:#ff6b6b"> Admin Panel</h2>
      <h3>All Users</h3>
      <div id="userList"></div>
    </div>
  </div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAirU2uIxkYvN0T3Onm4JwSrW87M6NzsXY",
  authDomain: "alexpaul-private-vault.firebaseapp.com",
  projectId: "alexpaul-private-vault",
  storageBucket: "alexpaul-private-vault.firebasestorage.app",
  messagingSenderId: "259166433078",
  appId: "1:259166433078:web:932c571cdeab4fbbb7cd97"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage().ref();

let currentUser = null;
let isAdmin = false;

// Auth listener
auth.onAuthStateChanged(async user => {
  if (user) {
    currentUser = user;
    const userDoc = await db.collection('users').doc(user.uid).get();
    isAdmin = userDoc.exists && userDoc.data().isAdmin === true;

    document.getElementById('auth').classList.add('hidden');
    document.getElementById('vault').classList.remove('hidden');
    document.getElementById('welcome').innerText = `— ${user.displayName || user.email}`;
    
    if (isAdmin) document.getElementById('adminPanel').classList.remove('hidden');

    loadFiles();
    loadChat();
    if (isAdmin) loadUserList();
  } else {
    document.getElementById('vault').classList.add('hidden');
    document.getElementById('auth').classList.remove('hidden');
    showLogin();
  }
});

// Auth functions
function showLogin() { document.getElementById('loginForm').classList.remove('hidden'); document.getElementById('signupForm').classList.add('hidden'); clearMsg(); }
function showSignup() { document.getElementById('loginForm').classList.add('hidden'); document.getElementById('signupForm').classList.remove('hidden'); clearMsg(); }
function clearMsg() { document.getElementById('authMsg').innerText = ''; document.getElementById('signupMsg').innerText = ''; }

window.login = async () => {
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value;
  try { await auth.signInWithEmailAndPassword(email, pass); }
  catch (e) { document.getElementById('authMsg').innerText = e.message; }
};

window.signup = async () => {
  const name = document.getElementById('displayName').value.trim();
  const email = document.getElementById('newEmail').value.trim();
  const pass = document.getElementById('newPass').value;
  if (pass.length < 6) return document.getElementById('signupMsg').innerText = "Password too short";
  try {
    const { user } = await auth.createUserWithEmailAndPassword(email, pass);
    await user.updateProfile({ displayName: name });
    await db.collection('users').doc(user.uid).set({ isAdmin: false });
    document.getElementById('signupMsg').innerText = "Account created! Logging in...";
  } catch (e) { document.getElementById('signupMsg').innerText = e.message; }
};

window.logout = () => auth.signOut();

// File upload/download/delete (unchanged)
window.uploadFiles = async () => { /* ... same as previous version ... */ 
  const files = document.getElementById('fileInput').files;
  const folder = document.getElementById('folderName').value.trim() || 'root';
  const progress = document.getElementById('uploadProgress');
  progress.style.display = 'block';
  for (let file of files) {
    const path = `${currentUser.uid}/${folder}/${file.name}`;
    const ref = storage.child(path);
    const task = ref.put(file);
    task.on('state_changed', snap => progress.value = (snap.bytesTransferred / snap.totalBytes) * 100);
    await task;
  }
  progress.style.display = 'none';
  document.getElementById('fileInput').value = '';
  loadFiles();
};

async function loadFiles() {
  const list = await storage.child(currentUser.uid).listAll();
  const grid = document.getElementById('files');
  grid.innerHTML = '';
  const folders = new Set();

  for (let prefix of list.prefixes) folders.add(prefix.name.split('/').pop());
  for (let item of list.items) {
    const parts = item.fullPath.split('/');
    const folderName = parts.slice(1, -1).join('/') || 'root';
    folders.add(folderName);
  }

  folders.forEach(f => {
    const div = document.createElement('div'); div.className = 'file-item';
    div.innerHTML = `<strong> ${f || 'root'}</strong>`;
    grid.appendChild(div);
  });

  for (let item of list.items) {
    const url = await item.getDownloadURL();
    const div = document.createElement('div'); div.className = 'file-item';
    div.innerHTML = `${item.name}<br><a href="${url}" target="_blank">Download</a>
      <button class="delete-btn" onclick="deleteFile('${item.fullPath}')">Delete</button>`;
    grid.appendChild(div);
  }
}

window.deleteFile = async (path) => {
  if (confirm("Delete this file?")) {
    await storage.child(path).delete();
    loadFiles();
  }
};

// Chat (unchanged)
window.sendMsg = async () => {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;
  await db.collection('chat').add({
    uid: currentUser.uid,
    name: currentUser.displayName || currentUser.email,
    text, time: firebase.firestore.FieldValue.serverTimestamp()
  });
  input.value = '';
};

function loadChat() {
  db.collection('chat').orderBy('time').onSnapshot(snap => {
    const chat = document.getElementById('chat');
    chat.innerHTML = '';
    snap.forEach(doc => {
      const d = doc.data();
      const div = document.createElement('div');
      div.className = `msg ${d.uid === currentUser.uid ? 'self' : ''}`;
      div.innerHTML = `<strong>${d.name}:</strong> ${d.text}`;
      chat.appendChild(div);
    });
    chat.scrollTop = chat.scrollHeight;
  });
}

// === ADMIN FUNCTIONS ===
async function loadUserList() {
  const list = document.getElementById('userList');
  list.innerHTML = '<p>Loading users...</p>';
  const snapshot = await db.collection('users').get();
  list.innerHTML = '';

  snapshot.forEach(doc => {
    const data = doc.data();
    const uid = doc.id;
    auth.getUser(uid).then(userRecord => {
      const el = document.createElement('div');
      el.className = 'user-item';
      el.innerHTML = `
        <div>
          <strong>${userRecord.displayName || 'No name'}</strong><br>
          <small>${userRecord.email}</small>
        </div>
        <div>
          <button onclick="toggleAdmin('${uid}', ${!data.isAdmin})" style="background:${data.isAdmin ? '#ff6b6b' : '#8b5cf6'}">
            ${data.isAdmin ? 'Revoke Admin' : 'Make Admin'}
          </button>
        </div>
      `;
      list.appendChild(el);
    });
  });
}

window.toggleAdmin = async (uid, makeAdmin) => {
  if (!confirm(makeAdmin ? "Give this user admin rights?" : "Revoke admin rights?")) return;
  await db.collection('users').doc(uid).update({ isAdmin: makeAdmin });
  loadUserList();
};

</script>
</body>
</html>